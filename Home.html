<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足球賠率篩選工具 (升級版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            color: #333;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            text-align: center;
        }
        .container {
            max-width: 1200px;
        }
        .nav-tabs .nav-link {
            color: #007bff;
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .filter-form {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-container {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 手機版卡片式佈局 */
        @media (max-width: 767px) {
            .table-responsive {
                border: none;
            }
            .table > :not(caption) > * > * {
                padding: 0;
            }
            .table thead {
                display: none; /* 隱藏傳統表格標頭 */
            }
            .table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 1rem;
                background-color: #fff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .table tbody td {
                display: block;
                text-align: right; /* 數據靠右 */
                padding: 0.5rem 0;
                border: none;
                position: relative;
            }
            .table tbody td::before {
                content: attr(data-label); /* 用 data-label 顯示標題 */
                position: absolute;
                left: 0;
                width: 50%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left; /* 標題靠左 */
                font-weight: bold;
                color: #555;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>足球賠率篩選工具 (v2.0)</h1>
    </header>

    <div class="container">
        <ul class="nav nav-tabs" id="oddsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="euro-tab" data-bs-toggle="tab" data-bs-target="#euro-panel" type="button" role="tab" data-odds-type="euro">歐洲賠率</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ah-tab" data-bs-toggle="tab" data-bs-target="#ah-panel" type="button" role="tab" data-odds-type="ah">亞洲讓球</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ou-tab" data-bs-toggle="tab" data-bs-target="#ou-panel" type="button" role="tab" data-odds-type="ou">大小球</button>
            </li>
        </ul>

        <div class="filter-form mt-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="season" class="form-label">球季</label>
                    <select id="season" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <label for="date-start" class="form-label">開始日期</label>
                    <input type="date" id="date-start" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="date-end" class="form-label">結束日期</label>
                    <input type="date" id="date-end" class="form-control">
                </div>
                
                <div id="dynamic-filters" class="row g-3 col-md-12"></div>

                <div class="col-md-12 d-flex justify-content-end">
                    <button type="button" id="reset-btn" class="btn btn-secondary me-2">清除條件</button>
                    <button type="button" id="filter-btn" class="btn btn-primary">篩選</button>
                </div>
            </div>
        </div>

        <div class="results-area mt-4">
            <div id="loader-container" class="text-center" style="display: none;">
                <div class="loader"></div>
                <p>計算中，請稍候...</p>
            </div>
            <div id="stats-container" class="stats-container" style="display: none;"></div>
            <div id="no-results" class="alert alert-warning text-center" style="display: none;">
                找不到符合條件嘅賽事，請嘗試放寬篩選條件。
            </div>
            <div id="results-table" class="table-responsive mt-3"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const oddsData = {
            euro: null,
            ah: null,
            ou: null
        };

        const dataFiles = {
            euro: 'european_odds.json',
            ah: 'asian_handicap.json',
            ou: 'over_under.json'
        };

        let currentOddsType = 'euro';
        let allSeasons = [];

        const elements = {
            seasonSelect: document.getElementById('season'),
            dateStart: document.getElementById('date-start'),
            dateEnd: document.getElementById('date-end'),
            dynamicFilters: document.getElementById('dynamic-filters'),
            filterBtn: document.getElementById('filter-btn'),
            resetBtn: document.getElementById('reset-btn'),
            loader: document.getElementById('loader-container'),
            statsContainer: document.getElementById('stats-container'),
            noResults: document.getElementById('no-results'),
            resultsTable: document.getElementById('results-table'),
            tabs: document.querySelectorAll('#oddsTab .nav-link')
        };

        // --- 數據加載與初始化 ---

        const fetchData = async (type) => {
            if (oddsData[type]) return oddsData[type]; // 如果已加載，直接返回
            try {
                const response = await fetch(dataFiles[type]);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                oddsData[type] = data;
                return data;
            } catch (error) {
                console.error(`無法加載 ${dataFiles[type]}:`, error);
                elements.resultsTable.innerHTML = `<div class="alert alert-danger">加載數據失敗，請檢查檔案 ${dataFiles[type]} 是否存在或格式正確。</div>`;
                return [];
            }
        };
        
        const initialize = async () => {
            elements.tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
            elements.filterBtn.addEventListener('click', runFilter);
            elements.resetBtn.addEventListener('click', resetAll);
            
            // 讀取 URL 參數並設置初始狀態
            const urlParams = new URLSearchParams(window.location.search);
            const initialTab = urlParams.get('tab') || 'euro';
            document.querySelector(`.nav-link[data-odds-type="${initialTab}"]`).click();

            await loadDataForCurrentTab(false); // 首次加載，不立即篩選
            
            // 等待數據加載後再從URL填充表單
            setTimeout(() => {
                populateFormFromUrl();
                // 如果URL有參數，自動觸發一次篩選
                if (urlParams.toString().length > 0) {
                     runFilter();
                }
            }, 100);
        };
        
        const loadDataForCurrentTab = async (autoFilter = true) => {
            showLoader(true);
            const data = await fetchData(currentOddsType);
            populateSeasonFilter(data);
            renderDynamicFilters();
            showLoader(false);
            if (autoFilter) runFilter();
        }

        const handleTabClick = (e) => {
            const newOddsType = e.target.getAttribute('data-odds-type');
            if (newOddsType !== currentOddsType) {
                currentOddsType = newOddsType;
                clearResults();
                loadDataForCurrentTab(false); // 切換tab時加載數據，但不自動篩選
            }
        };

        // --- 篩選器與表單處理 ---
        
        const populateSeasonFilter = (data) => {
            const seasons = [...new Set(data.map(item => item.season))].sort((a, b) => b.localeCompare(a));
            allSeasons = seasons;
            elements.seasonSelect.innerHTML = '<option value="">所有球季</option>' + seasons.map(s => `<option value="${s}">${s}</option>`).join('');
        };
        
        const renderDynamicFilters = () => {
            let html = '';
            if (currentOddsType === 'euro') {
                html = `
                    <div class="col-md-3"><label class="form-label">初盤主勝</label><div class="input-group"><input type="number" id="h_odd_i_min" class="form-control" placeholder="Min"><input type="number" id="h_odd_i_max" class="form-control" placeholder="Max"></div></div>
                    <div class="col-md-3"><label class="form-label">初盤和</label><div class="input-group"><input type="number" id="d_odd_i_min" class="form-control" placeholder="Min"><input type="number" id="d_odd_i_max" class="form-control" placeholder="Max"></div></div>
                    <div class="col-md-3"><label class="form-label">初盤客勝</label><div class="input-group"><input type="number" id="a_odd_i_min" class="form-control" placeholder="Min"><input type="number" id="a_odd_i_max" class="form-control" placeholder="Max"></div></div>
                `;
            } else if (currentOddsType === 'ah') {
                html = `
                    <div class="col-md-3"><label class="form-label">初盤盤口</label><div class="input-group"><input type="number" step="0.25" id="hcap_line_i_min" class="form-control" placeholder="Min"><input type="number" step="0.25" id="hcap_line_i_max" class="form-control" placeholder="Max"></div></div>
                    <div class="col-md-3"><label class="form-label">初盤主賠</label><div class="input-group"><input type="number" step="0.01" id="h_odd_i_min" class="form-control" placeholder="Min"><input type="number" step="0.01" id="h_odd_i_max" class="form-control" placeholder="Max"></div></div>
                    <div class="col-md-3"><label class="form-label">初盤客賠</label><div class="input-group"><input type="number" step="0.01" id="a_odd_i_min" class="form-control" placeholder="Min"><input type="number" step="0.01" id="a_odd_i_max" class="form-control" placeholder="Max"></div></div>
                `;
            } else if (currentOddsType === 'ou') {
                html = `
                    <div class="col-md-3"><label class="form-label">初盤大小線</label><div class="input-group"><input type="number" step="0.25" id="line_i_min" class="form-control" placeholder="Min"><input type="number" step="0.25" id="line_i_max" class="form-control" placeholder="Max"></div></div>
                    <div class="col-md-3"><label class="form-label">初盤大球賠率</label><div class="input-group"><input type="number" step="0.01" id="o_odd_i_min" class="form-control" placeholder="Min"><input type="number" step="0.01" id="o_odd_i_max" class="form-control" placeholder="Max"></div></div>
                    <div class="col-md-3"><label class="form-label">初盤小球賠率</label><div class="input-group"><input type="number" step="0.01" id="u_odd_i_min" class="form-control" placeholder="Min"><input type="number" step="0.01" id="u_odd_i_max" class="form-control" placeholder="Max"></div></div>
                `;
            }
            elements.dynamicFilters.innerHTML = html;
        };
        
        const getFormValues = () => {
            const values = {
                tab: currentOddsType,
                season: elements.seasonSelect.value,
                dateStart: elements.dateStart.value,
                dateEnd: elements.dateEnd.value,
            };
            const filterInputs = elements.dynamicFilters.querySelectorAll('input');
            filterInputs.forEach(input => {
                if(input.value) values[input.id] = input.value;
            });
            return values;
        };

        const updateUrl = (filters) => {
            const urlParams = new URLSearchParams();
            for (const key in filters) {
                if (filters[key]) {
                    urlParams.set(key, filters[key]);
                }
            }
            window.history.pushState({}, '', `?${urlParams.toString()}`);
        };

        const populateFormFromUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.forEach((value, key) => {
                const el = document.getElementById(key);
                if (el) {
                    if (el.tagName === 'SELECT' || el.tagName === 'INPUT') {
                        el.value = value;
                    }
                }
            });
        };

        // --- 核心篩選與渲染邏輯 ---
        
        const runFilter = () => {
            showLoader(true);
            clearResults();
            
            // 使用 setTimeout 確保 loader 優先渲染
            setTimeout(() => {
                const filters = getFormValues();
                updateUrl(filters); // 更新 URL
                
                const data = oddsData[currentOddsType];
                if (!data) {
                    showLoader(false);
                    return;
                }
                
                const filteredData = data.filter(item => {
                    const matchDate = new Date(item.match_date);
                    if (filters.season && item.season !== filters.season) return false;
                    if (filters.dateStart && matchDate < new Date(filters.dateStart)) return false;
                    if (filters.dateEnd && matchDate > new Date(filters.dateEnd)) return false;
                    
                    // 動態賠率條件過濾
                    for(const key in filters) {
                        if (key.endsWith('_min') && item[key.replace('_min', '_i')] < parseFloat(filters[key])) return false;
                        if (key.endsWith('_max') && item[key.replace('_max', '_i')] > parseFloat(filters[key])) return false;
                    }
                    return true;
                });
                
                renderResults(filteredData);
                showLoader(false);
            }, 10); 
        };
        
        const renderResults = (data) => {
            if (data.length === 0) {
                elements.noResults.style.display = 'block';
                return;
            }
            
            let statsHtml = '';
            let tableHtml = '';
            
            if (currentOddsType === 'euro') {
                const stats = { win: 0, draw: 0, lose: 0 };
                data.forEach(d => {
                    const [homeScore, awayScore] = d.final_score.split(':').map(Number);
                    if (homeScore > awayScore) stats.win++;
                    else if (homeScore === awayScore) stats.draw++;
                    else stats.lose++;
                });
                statsHtml = generateStatsHtml(stats, data.length, ['主勝', '和', '客負']);
                tableHtml = `
                    <table class="table table-striped table-hover">
                        <thead><tr><th>日期</th><th>聯賽</th><th>主隊</th><th>客隊</th><th>比分</th><th>初盤(W/D/L)</th><th>終盤(W/D/L)</th></tr></thead>
                        <tbody>${data.map(d => `
                            <tr>
                                <td data-label="日期">${d.match_date}</td>
                                <td data-label="聯賽">${d.league}</td>
                                <td data-label="主隊">${d.home_team}</td>
                                <td data-label="客隊">${d.away_team}</td>
                                <td data-label="比分">${d.final_score}</td>
                                <td data-label="初盤">${d.h_odd_i}/${d.d_odd_i}/${d.a_odd_i}</td>
                                <td data-label="終盤">${d.h_odd_f}/${d.d_odd_f}/${d.a_odd_f}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
            } else if (currentOddsType === 'ah') {
                const stats = { win: 0, lose: 0, push: 0 };
                data.forEach(d => {
                    const [homeScore, awayScore] = d.final_score.split(':').map(Number);
                    const diff = homeScore - awayScore;
                    const result = diff + d.hcap_line_f; // 用終盤計算
                    if (result > 0) stats.win++;
                    else if (result < 0) stats.lose++;
                    else stats.push++;
                });
                statsHtml = generateStatsHtml(stats, data.length, ['贏盤', '輸盤', '走水']);
                 tableHtml = `
                    <table class="table table-striped table-hover">
                        <thead><tr><th>日期</th><th>主隊</th><th>客隊</th><th>比分</th><th>初盤(盤/主/客)</th><th>終盤(盤/主/客)</th></tr></thead>
                        <tbody>${data.map(d => `
                            <tr>
                                <td data-label="日期">${d.match_date}</td>
                                <td data-label="主隊">${d.home_team}</td>
                                <td data-label="客隊">${d.away_team}</td>
                                <td data-label="比分">${d.final_score}</td>
                                <td data-label="初盤">${d.hcap_line_i} / ${d.h_odd_i} / ${d.a_odd_i}</td>
                                <td data-label="終盤">${d.hcap_line_f} / ${d.h_odd_f} / ${d.a_odd_f}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
            } else if (currentOddsType === 'ou') {
                const stats = { over: 0, under: 0 };
                data.forEach(d => {
                     const [homeScore, awayScore] = d.final_score.split(':').map(Number);
                     const totalGoals = homeScore + awayScore;
                     if (totalGoals > d.line_f) stats.over++;
                     else stats.under++;
                });
                statsHtml = generateStatsHtml(stats, data.length, ['大球', '小球']);
                 tableHtml = `
                    <table class="table table-striped table-hover">
                        <thead><tr><th>日期</th><th>主隊</th><th>客隊</th><th>比分</th><th>初盤(線/大/小)</th><th>終盤(線/大/小)</th></tr></thead>
                        <tbody>${data.map(d => `
                            <tr>
                                <td data-label="日期">${d.match_date}</td>
                                <td data-label="主隊">${d.home_team}</td>
                                <td data-label="客隊">${d.away_team}</td>
                                <td data-label="比分">${d.final_score}</td>
                                <td data-label="初盤">${d.line_i} / ${d.o_odd_i} / ${d.u_odd_i}</td>
                                <td data-label="終盤">${d.line_f} / ${d.o_odd_f} / ${d.u_odd_f}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
            }

            elements.statsContainer.innerHTML = statsHtml;
            elements.statsContainer.style.display = 'block';
            elements.resultsTable.innerHTML = tableHtml;
        };

        const generateStatsHtml = (stats, total, labels) => {
            let html = `<h5 class="mb-3">統計結果 (共 ${total} 場)</h5><div class="row">`;
            let i = 0;
            for (const key in stats) {
                const count = stats[key];
                const percentage = total > 0 ? (count / total * 100).toFixed(2) : 0;
                html += `
                    <div class="col-md-4">
                        <strong>${labels[i]}</strong>: ${count} 場 (${percentage}%)
                    </div>`;
                i++;
            }
            html += `</div>`;
            return html;
        };
        
        // ---輔助函數---

        const showLoader = (show) => {
            elements.loader.style.display = show ? 'block' : 'none';
        };

        const clearResults = () => {
            elements.statsContainer.innerHTML = '';
            elements.statsContainer.style.display = 'none';
            elements.resultsTable.innerHTML = '';
            elements.noResults.style.display = 'none';
        };
        
        const resetAll = () => {
            document.querySelector('.filter-form').reset(); // 重設表單
            renderDynamicFilters(); // 重新渲染動態篩選器以清空它們
            clearResults();
            updateUrl({}); // 清空 URL 參數
        };

        // --- 啟動應用 ---
        initialize();
    });
    </script>
</body>
</html>
